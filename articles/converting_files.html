<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Converting from XPT • datasetjson</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Converting from XPT">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-165685385-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-165685385-2');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">datasetjson</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/datasetjson.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Vignettes</h6></li>
    <li><a class="dropdown-item" href="../articles/date_time_datetime.html">Dates, Times, and Datetimes</a></li>
    <li><a class="dropdown-item" href="../articles/converting_files.html">Converting from XPT</a></li>
    <li><a class="dropdown-item" href="../articles/odm_details.html">Notes on ODM V2</a></li>
    <li><a class="dropdown-item" href="../articles/precision.html">Numeric Precision</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/atorus-research/datasetjson" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Converting from XPT</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/atorus-research/datasetjson/blob/main/vignettes/converting_files.Rmd" class="external-link"><code>vignettes/converting_files.Rmd</code></a></small>
      <div class="d-none name"><code>converting_files.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://atorus-research.github.io/datasetjson/">datasetjson</a></span><span class="op">)</span></span></code></pre></div>
<p>Some users may be interested in converting SAS Version 5 Transport
files into XPT, or converting from other file types such as SAS7BDAT.
There may be some existing processes in place to do this in SAS, such as
a post-processing conversion step where files are converted in bulk.
This vignette offers some guidance and best practice for doing this
process in R.</p>
<div class="section level2">
<h2 id="converting-from-xpt">Converting from XPT<a class="anchor" aria-label="anchor" href="#converting-from-xpt"></a>
</h2>
<p>Ideally if you’re converting from an XPT file or a SAS7BDAT file, the
appropriate metadata would be maintained separate from the dataset
itself. Inevitably some information will get lost while being exchanged
because of differences of what information was applied or how R
interprets SAS datasets. This is one reason why
<strong>{datasetjson}</strong> improves upon XPTs as an exchange format.
In leiu of external metadata, here’s an example of how you can make a
best effort conversion.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu"><a href="https://haven.tidyverse.org/reference/read_xpt.html" class="external-link">read_xpt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">'datasetjson'</span><span class="op">)</span>, <span class="st">"adsl.xpt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Gather variable metadata in Dataset JSON compliant format</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param n Variable name</span></span>
<span><span class="co">#' @param .data Dataset to gather attributes</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns Columns compliant data frame</span></span>
<span><span class="va">extract_xpt_meta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">.data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">attrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Identify the variable type</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>,<span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">dataType</span> <span class="op">&lt;-</span> <span class="st">"date"</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">targetDataType</span> <span class="op">&lt;-</span> <span class="st">"integer"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>,<span class="st">"POSIXt"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">dataType</span> <span class="op">&lt;-</span> <span class="st">"datetime"</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">targetDataType</span> <span class="op">&lt;-</span> <span class="st">"integer"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>,<span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">is.double</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="va">out</span><span class="op">$</span><span class="va">dataType</span> <span class="op">&lt;-</span> <span class="st">"float"</span></span>
<span>    <span class="kw">else</span> <span class="va">out</span><span class="op">$</span><span class="va">dataType</span> <span class="op">&lt;-</span> <span class="st">"integer"</span></span>
<span>  <span class="op">}</span>  <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>,<span class="st">"hms"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">dataType</span> <span class="op">&lt;-</span> <span class="st">"time"</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">targetDataType</span> <span class="op">&lt;-</span> <span class="st">"integer"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">dataType</span> <span class="op">&lt;-</span> <span class="st">"string"</span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_int</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>, <span class="va">nchar</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">itemOID</span> <span class="op">&lt;-</span> <span class="va">n</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">n</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>, <span class="st">'label'</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">displayFormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>, <span class="st">'format.sas'</span><span class="op">)</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Loop the ADSL columns</span></span>
<span><span class="va">adsl_meta</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adsl</span><span class="op">)</span>, <span class="va">extract_xpt_meta</span>, .data<span class="op">=</span><span class="va">adsl</span><span class="op">)</span></span>
<span><span class="va">adsl_meta</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 49 × 7</span></span></span>
<span><span class="co">#&gt;    dataType length itemOID name    label            targetDataType displayFormat</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> string       12 STUDYID STUDYID Study Identifier <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> string       11 USUBJID USUBJID Unique Subject … <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> string        4 SUBJID  SUBJID  Subject Identif… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> string        3 SITEID  SITEID  Study Site Iden… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> string        3 SITEGR1 SITEGR1 Pooled Site Gro… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> string       20 ARM     ARM     Description of … <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> string       20 TRT01P  TRT01P  Planned Treatme… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> float        <span style="color: #BB0000;">NA</span> TRT01PN TRT01PN Planned Treatme… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> string       20 TRT01A  TRT01A  Actual Treatmen… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> float        <span style="color: #BB0000;">NA</span> TRT01AN TRT01AN Actual Treatmen… <span style="color: #BB0000;">NA</span>             <span style="color: #BB0000;">NA</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 39 more rows</span></span></span></code></pre></div>
<p>Now that we have the metadata, we can use this to write out the
Dataset JSON file.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the datasetjson object</span></span>
<span><span class="va">ds_json</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dataset_json.html">dataset_json</a></span><span class="op">(</span></span>
<span>  <span class="va">adsl</span>, </span>
<span>  item_oid <span class="op">=</span> <span class="st">"ADSL"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"ADSL"</span>,</span>
<span>  dataset_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="st">'label'</span><span class="op">)</span>,</span>
<span>  columns <span class="op">=</span> <span class="va">adsl_meta</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write the JSON</span></span>
<span><span class="va">json_file_content</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_dataset_json.html">write_dataset_json</a></span><span class="op">(</span><span class="va">ds_json</span><span class="op">)</span></span></code></pre></div>
<p>Just for good measure, we can confirm the metadata we just created is
compliant with the schema.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check schema compliance</span></span>
<span><span class="fu"><a href="../reference/validate_dataset_json.html">validate_dataset_json</a></span><span class="op">(</span><span class="va">json_file_content</span><span class="op">)</span></span>
<span><span class="co">#&gt; File is valid per the Dataset JSON v1.1.0 schema</span></span>
<span><span class="co">#&gt; [1] instancePath schemaPath   keyword      params       message     </span></span>
<span><span class="co">#&gt; [6] schema       parentSchema dataPath    </span></span>
<span><span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bulk-file-conversion">Bulk File Conversion<a class="anchor" aria-label="anchor" href="#bulk-file-conversion"></a>
</h2>
<p>If your intention is to convert files into Dataset JSON format in
bulk, there are a couple things you should consider - especially if
you’re trying to replicate existing procedures done using SAS:</p>
<p>Remember that R by default holds data in memory, whereas work
datasets in SAS are still written to disk. This means that if you’re
doing a bulk conversion of datasets, you’ll want to read in and write
out one dataset at a time. For example:</p>
<ol style="list-style-type: decimal">
<li>Read in the XPT or SAS7BDAT file</li>
<li>Write out the Dataset JSON file</li>
<li>Remove the objects from memory to free up space</li>
</ol>
<p>It’s likely best to wrap the conversion process in a function,
because the function namespace will inherently release the temporary
objects during garbage collection. Depending on the size of your data,
it could be easy to max out memory if you first read in all the
datasets.</p>
<p>A second consideration is use of the function
<code><a href="../reference/validate_dataset_json.html">validate_dataset_json()</a></code>. Particularly if you have large
datasets, we recommend <em>against</em> using this function. The
validation it performs is against the Dataset JSON schema - so it’s not
performing additional CDISC checks on the data. We offer this function
primarily due to the fact that the schema is available, and if necessary
the function allows you to check that the schema compliance is met. That
said, we’ve done the testing to make sure that
<code><a href="../reference/write_dataset_json.html">write_dataset_json()</a></code> writes the file out using a compliant
schema - so this step is redundant.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Stackhouse, Nicholas Masel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

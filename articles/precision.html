<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Numeric Precision • datasetjson</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Numeric Precision">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-165685385-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-165685385-2');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">datasetjson</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/datasetjson.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Vignettes</h6></li>
    <li><a class="dropdown-item" href="../articles/date_time_datetime.html">Dates, Times, and Datetimes</a></li>
    <li><a class="dropdown-item" href="../articles/converting_files.html">Converting from XPT</a></li>
    <li><a class="dropdown-item" href="../articles/odm_details.html">Notes on ODM V2</a></li>
    <li><a class="dropdown-item" href="../articles/precision.html">Numeric Precision</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/atorus-research/datasetjson" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Numeric Precision</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/atorus-research/datasetjson/blob/main/vignettes/precision.Rmd" class="external-link"><code>vignettes/precision.Rmd</code></a></small>
      <div class="d-none name"><code>precision.Rmd</code></div>
    </div>

    
    
<p>Numeric precision and issues with floating point decimals is a common
problem to come across when working with data. Dataset JSON is not
immune to these issues. Instead of writing out direct binary
representations of the floating point numbers, which will vary depending
on the system being used and the standard followed, Dataset JSON writes
out character representations of these numbers. As such, when the
numbers are serialized from numeric to character, and then read back
into numeric format, you may come across precision issues.</p>
<p>Consider the following example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://atorus-research.github.io/datasetjson/">datasetjson</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span></span>
<span><span class="va">test_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">iris</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">test_df</span><span class="op">[</span><span class="st">'float_col'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">143.66666666666699825</span>,</span>
<span>  <span class="fl">2</span><span class="op">/</span><span class="fl">3</span>,</span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>,</span>
<span>  <span class="fl">165</span><span class="op">/</span><span class="fl">37</span>,</span>
<span>  <span class="fl">6</span><span class="op">/</span><span class="fl">7</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_items</span> <span class="op">&lt;-</span> <span class="va">iris_items</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    itemOID <span class="op">=</span> <span class="st">"IT.IR.float_col"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"float_col"</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Test column long decimal"</span>,</span>
<span>    dataType <span class="op">=</span> <span class="st">"float"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dsjson</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dataset_json.html">dataset_json</a></span><span class="op">(</span></span>
<span>  <span class="va">test_df</span>, </span>
<span>  item_oid <span class="op">=</span> <span class="st">"test_df"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"test_df"</span>,</span>
<span>  dataset_label <span class="op">=</span> <span class="st">"test_df"</span>,</span>
<span>  columns <span class="op">=</span> <span class="va">test_items</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">json_out</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/write_dataset_json.html">write_dataset_json</a></span><span class="op">(</span><span class="va">dsjson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_dataset_json.html">read_dataset_json</a></span><span class="op">(</span><span class="va">json_out</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_df</span><span class="op">$</span><span class="va">float_col</span> <span class="op">-</span> <span class="va">out</span><span class="op">$</span><span class="va">float_col</span></span>
<span><span class="co">#&gt; [1] -3.333330e-07 -3.333333e-07  3.333333e-07  4.594595e-07 -1.428571e-07</span></span>
<span><span class="co">#&gt; attr(,"label")</span></span>
<span><span class="co">#&gt; [1] "Test column long decimal"</span></span></code></pre></div>
<p>In this case, we start seeing differences at the 7th decimal point.
To look at a specific value, the input of
<code>143.66666666666699825</code> is written out in the JSON file as
<code>143.666666666667</code>. This issue isn’t unique to R either. If
you’re ever converted numeric to character and back to numeric in SAS,
you’ll likely have encountered a similar problem.</p>
<p>In the <strong>{datasetjson}</strong> package, the
<strong>{yyjsonr}</strong> package is doing the heavy lifting of
serializing the R numeric value into a character string. The underlying
C library has some <a href="https://github.com/ibireme/yyjson/commit/6d416047822d86d53a3a0b45a6a5abf28383a1dc" class="external-link">recent
updates</a> to work on improving read output number precision which we
hope will improve the handling.</p>
<p>Another way to handle numeric precision issues is to use the
“decimal” types that’s available in the Dataset JSON standard. From the
<a href="https://wiki.cdisc.org/display/PUB/Precision+and+Rounding" class="external-link">user
guide</a>, this can be described as follows:</p>
<blockquote>
<h2 id="decimal-data-type">Decimal Data Type</h2>
<p>Although the pilot findings on precision and rounding did not point
to a problem with Dataset-JSON, the Dataset-JSON Team opted to add the
Decimal datatype. The Decimal datatype has been available in ODM for
many years. The basic premise for this datatype is to represent the
number in Dataset-JSON as a string (a quoted set of numeric characters)
to prevent JSON libraries from interpreting the number as a float before
the software application gets access to it.</p>
<p>To use decimal in Dataset-JSON, set the dataType to decimal and the
targetDataType to decimal. This instructs conversion software to convert
the number it reads from a native dataset into a string in Dataset-JSON.
It also instructs the receiver to convert the number as a string into
the decimal datatype or closest approximation available in the receiving
technology. Note that not all technologies support an explicit decimal
datatype.</p>
</blockquote>
<p>In order to address this problem, we’ve added the options
<code>floats_as_decimals</code> and <code>digits</code> to
<code><a href="../reference/write_dataset_json.html">write_dataset_json()</a></code> and <code>decimals_as_floats</code> to
<code><a href="../reference/read_dataset_json.html">read_dataset_json()</a></code>.</p>
<p>Considering the example before, here’s how these options can
help.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">json_out</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/write_dataset_json.html">write_dataset_json</a></span><span class="op">(</span><span class="va">dsjson</span>, float_as_decimals <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_dataset_json.html">read_dataset_json</a></span><span class="op">(</span><span class="va">json_out</span>, decimals_as_floats <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_df</span><span class="op">$</span><span class="va">float_col</span> <span class="op">-</span> <span class="va">out</span><span class="op">$</span><span class="va">float_col</span></span>
<span><span class="co">#&gt; [1] 0 0 0 0 0</span></span>
<span><span class="co">#&gt; attr(,"label")</span></span>
<span><span class="co">#&gt; [1] "Test column long decimal"</span></span></code></pre></div>
<p>By manually handling how the decimal precision is rendered, the
values were able to serialize and re-import more effectively.</p>
<p>There are a few reasons we’ve chosen to NOT make this default
behavior:</p>
<ul>
<li>This inherently adds overhead, because we convert the values prior
to letting <code>yyjsonr</code> serialize them</li>
<li>We’re changing the way the metadata is writing to use the
<code>decimal</code> type. While the standard supports the use of the
<code>decimal</code> type, it’s an extra step that that the consuming
system needs to be aware of, and Dataset JSON is still a young
standard.</li>
<li>Our hope is that the <code>yyjson</code> C package grows to make
this extra step less necessary</li>
</ul>
<p>As one last note, we default our choice of decimal precision to use
16 digits. The reason we’ve chosen to do this is as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fl">.2</span>, digits<span class="op">=</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "0.2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fl">.2</span>, digits<span class="op">=</span><span class="fl">17</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "0.20000000000000001"</span></span></code></pre></div>
<p>After a certain point, displaying extra digits is just going to show
the where floating point values start to break down. 16 digits balances
preserving the precision of output without turning low precision numbers
into overly precise ones.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Stackhouse, Nicholas Masel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
